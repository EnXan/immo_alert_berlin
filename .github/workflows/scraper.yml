# .github/workflows/degewo_scraper.yml
name: Wohnungs Scraper

on:
  schedule:
    - cron: '0,30 7-20 * * 1-5'
  
  workflow_dispatch:  # Manueller Trigger
  
  push:
    branches: [main]

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Pull latest changes
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git pull origin main || true
    
    # UV Installation (super schnell!)
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    # Python Setup mit uv
    - name: Set up Python
      run: uv python install 3.12
    
    # Dependencies mit uv
    - name: Install dependencies
      run: |
        uv sync --frozen
        uv run playwright install chromium
        uv run playwright install-deps chromium
    
    # Scraper ausf√ºhren
    - name: Run Scraper
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
      run: |
        uv run python -m src.orchestrator
    
    # √Ñnderungen committen
    - name: Commit database changes
      run: |
        git add database/database.json database/archive.json || true
        git diff --staged --quiet || (
          git commit -m "üè† Update listings - $(date +'%Y-%m-%d %H:%M')" &&
          git push origin main
        )