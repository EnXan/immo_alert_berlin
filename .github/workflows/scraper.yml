name: Wohnungs Scraper

on:
  schedule:
    - cron: '0, 5-18 * * 1-5'
  
  workflow_dispatch:  # Manueller Trigger

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Pull latest changes
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git pull origin main || true
    
    # UV Installation (super schnell!)
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    # Python Setup mit uv
    - name: Set up Python
      run: uv python install 3.12
    
    # Dependencies mit uv
    - name: Install dependencies
      run: |
        uv sync --frozen
        uv run playwright install chromium
        uv run playwright install-deps chromium
    
    # Scraper ausfÃ¼hren
    - name: Run Scraper
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
      run: |
        echo "ğŸš€ Starting scraper..."
        uv run python cli.py run
        echo "âœ… Scraper finished"
    
    # Debug: Check what files changed
    - name: Check file changes
      run: |
        echo "ğŸ“ Files in database directory:"
        ls -la database/
        echo "ğŸ” Git status:"
        git status
        echo "ğŸ“ Git diff:"
        git diff database/
    
    # Ã„nderungen committen
    - name: Commit database changes
      run: |
        # Alle Ã„nderungen im database/ Ordner hinzufÃ¼gen
        git add database/ || true
        
        if ! git diff --staged --quiet; then
          echo "ğŸ“ Changes detected, committing..."
          git commit -m "ğŸ  Update listings - $(date +'%Y-%m-%d %H:%M')"
          git push origin main
          echo "âœ… Changes pushed successfully"
        else
          echo "â„¹ï¸  No changes to commit"
        fi
